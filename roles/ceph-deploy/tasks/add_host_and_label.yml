---
- name: Copy SSH public key to each client host
  ansible.builtin.shell: |
    ssh-copy-id -i /etc/ceph/ceph.pub -o StrictHostKeyChecking=no {{ ssh_user }}@{{ hostvars[item]['ansible_host'] }} || \
    echo "{{ item }}: Key already exists or another error occurred."
  loop: "{{ groups['clients'] }}"
  loop_control:
    loop_var: item

- name: Add admin host to Ceph cluster and apply mon,mgr labels
  ansible.builtin.shell: |
    sudo ceph orch host add {{ item }} {{ hostvars[item]['ansible_host'] }} && \
    sudo ceph orch host label add {{ item }} mon,mgr || \
    echo "{{ item }}: Failed to add and label as mon,mgr."
  loop: "{{ groups['admin'] }}"
  loop_control:
    loop_var: item

- name: Add OSD host to Ceph cluster and apply osd label
  ansible.builtin.shell: |
    sudo ceph orch host add {{ item }} {{ hostvars[item]['ansible_host'] }} && \
    sudo ceph orch host label add {{ item }} osd || \
    echo "{{ item }}: Failed to add and label as osd."
  loop: "{{ groups['osds'] }}"
  loop_control:
    loop_var: item

- name: Label specific hosts with '_no_schedule'
  ansible.builtin.shell: |
    sudo ceph orch host label add {{ item }} _no_schedule || \
    echo "{{ item }}: Failed to label as '_no_schedule'."
  loop: "{{ groups['clients'] }}"
  loop_control:
    loop_var: item
  when: item not in groups['admin'] and item not in groups['osds']
